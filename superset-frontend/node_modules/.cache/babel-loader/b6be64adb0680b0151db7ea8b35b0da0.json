{"ast":null,"code":"import \"core-js/modules/web.dom-collections.iterator.js\";import _Object$keys from \"@babel/runtime-corejs3/core-js-stable/object/keys\";import _Set from \"@babel/runtime-corejs3/core-js-stable/set\";import _findInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/find\";import _Object$entries from \"@babel/runtime-corejs3/core-js-stable/object/entries\";import _includesInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/includes\";import _sortInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/sort\";import _filterInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/filter\";import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _forEachInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/for-each\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;};import { CHART_TYPE, DASHBOARD_ROOT_TYPE, TABS_TYPE, TAB_TYPE } from 'src/dashboard/util/componentTypes';\nexport const isShowTypeInTree = ({ type, meta }, charts) => {var _charts$meta$chartId, _charts$meta$chartId$;return (type === TABS_TYPE ||\n  type === TAB_TYPE ||\n  type === CHART_TYPE ||\n  type === DASHBOARD_ROOT_TYPE) && (\n  !charts || ((_charts$meta$chartId = charts[meta == null ? void 0 : meta.chartId]) == null ? void 0 : (_charts$meta$chartId$ = _charts$meta$chartId.formData) == null ? void 0 : _charts$meta$chartId$.viz_type) !== 'filter_box');};\nexport const buildTree = (node, treeItem, layout, charts) => {var _context;\n  let itemToPass = treeItem;\n  if (isShowTypeInTree(node, charts) && node.type !== DASHBOARD_ROOT_TYPE) {\n    const currentTreeItem = {\n      key: node.id,\n      title: node.meta.sliceName || node.meta.text || node.id.toString(),\n      children: [] };\n\n    treeItem.children.push(currentTreeItem);\n    itemToPass = currentTreeItem;\n  }\n  _forEachInstanceProperty(_context = node.children).call(_context, child => buildTree(layout[child], itemToPass, layout, charts));\n};\nexport const findFilterScope = (checkedKeys, layout) => {var _context3;\n  if (!checkedKeys.length) {\n    return {\n      rootPath: [],\n      excluded: [] };\n\n  }\n  const checkedItemParents = _mapInstanceProperty(checkedKeys).call(checkedKeys, key => {var _context2;return _filterInstanceProperty(_context2 = layout[key].parents || []).call(_context2, parent => isShowTypeInTree(layout[parent]));});\n  _sortInstanceProperty(checkedItemParents).call(checkedItemParents, (p1, p2) => p1.length - p2.length);\n  const rootPath = _mapInstanceProperty(checkedItemParents).call(checkedItemParents, parents => parents[checkedItemParents[0].length - 1]);\n  const excluded = [];\n  const isExcluded = (parent, item) => _includesInstanceProperty(rootPath).call(rootPath, parent) && !_includesInstanceProperty(checkedKeys).call(checkedKeys, item);\n  _forEachInstanceProperty(_context3 = _Object$entries(layout)).call(_context3, ([key, value]) => {var _value$parents;\n    if (value.type === CHART_TYPE && (_value$parents =\n    value.parents) != null && _findInstanceProperty(_value$parents).call(_value$parents, parent => isExcluded(parent, key))) {\n      excluded.push(value.meta.chartId);\n    }\n  });\n  return {\n    rootPath: [...new _Set(rootPath)],\n    excluded };\n\n};\nexport function mergeExtraFormData(originalExtra, newExtra) {\n  const { override_form_data: originalOverride = {}, append_form_data: originalAppend = {} } = originalExtra;\n  const { override_form_data: newOverride = {}, append_form_data: newAppend = {} } = newExtra;\n  const appendKeys = new _Set([\n  ..._Object$keys(originalAppend),\n  ..._Object$keys(newAppend)]);\n\n  const appendFormData = {};\n  _forEachInstanceProperty(appendKeys).call(appendKeys, key => {\n    appendFormData[key] = [\n    // @ts-ignore\n    ...(originalAppend[key] || []),\n    // @ts-ignore\n    ...(newAppend[key] || [])];\n\n  });\n  return {\n    override_form_data: {\n      ...originalOverride,\n      ...newOverride },\n\n    append_form_data: appendFormData };\n\n}\nexport function getExtraFormData(nativeFilters) {var _context4;\n  let extraFormData = {};\n  _forEachInstanceProperty(_context4 = _Object$keys(nativeFilters.filters)).call(_context4, key => {\n    const filterState = nativeFilters.filtersState[key] || {};\n    const { extraFormData: newExtra = {} } = filterState;\n    extraFormData = mergeExtraFormData(extraFormData, newExtra);\n  });\n  return extraFormData;\n}\nexport function mapParentFiltersToChildren(filters) {\n  const cascadeChildren = {};\n  _forEachInstanceProperty(filters).call(filters, filter => {\n    const [parentId] = filter.cascadeParentIds || [];\n    if (parentId) {\n      if (!cascadeChildren[parentId]) {\n        cascadeChildren[parentId] = [];\n      }\n      cascadeChildren[parentId].push(filter);\n    }\n  });\n  return cascadeChildren;\n}\nexport function buildCascadeFiltersTree(filters) {var _context5;\n  const cascadeChildren = mapParentFiltersToChildren(filters);\n  const getCascadeFilter = filter => {\n    const children = cascadeChildren[filter.id] || [];\n    return {\n      ...filter,\n      cascadeChildren: _mapInstanceProperty(children).call(children, getCascadeFilter) };\n\n  };\n  return _mapInstanceProperty(_context5 = _filterInstanceProperty(filters).call(filters,\n  filter => {var _filter$cascadeParent;return !((_filter$cascadeParent = filter.cascadeParentIds) != null && _filter$cascadeParent.length);})).call(_context5,\n  getCascadeFilter);\n};(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(isShowTypeInTree, \"isShowTypeInTree\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/utils.ts\");reactHotLoader.register(buildTree, \"buildTree\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/utils.ts\");reactHotLoader.register(findFilterScope, \"findFilterScope\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/utils.ts\");reactHotLoader.register(mergeExtraFormData, \"mergeExtraFormData\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/utils.ts\");reactHotLoader.register(getExtraFormData, \"getExtraFormData\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/utils.ts\");reactHotLoader.register(mapParentFiltersToChildren, \"mapParentFiltersToChildren\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/utils.ts\");reactHotLoader.register(buildCascadeFiltersTree, \"buildCascadeFiltersTree\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/utils.ts\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/app/superset-frontend/src/dashboard/components/nativeFilters/utils.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport { ExtraFormData, QueryObject } from '@superset-ui/core';\nimport { Charts, Layout, LayoutItem } from 'src/dashboard/types';\nimport {\n  CHART_TYPE,\n  DASHBOARD_ROOT_TYPE,\n  TABS_TYPE,\n  TAB_TYPE,\n} from 'src/dashboard/util/componentTypes';\nimport {\n  CascadeFilter,\n  Filter,\n  NativeFiltersState,\n  Scope,\n  TreeItem,\n} from './types';\n\nexport const isShowTypeInTree = ({ type, meta }: LayoutItem, charts?: Charts) =>\n  (type === TABS_TYPE ||\n    type === TAB_TYPE ||\n    type === CHART_TYPE ||\n    type === DASHBOARD_ROOT_TYPE) &&\n  (!charts || charts[meta?.chartId]?.formData?.viz_type !== 'filter_box');\n\nexport const buildTree = (\n  node: LayoutItem,\n  treeItem: TreeItem,\n  layout: Layout,\n  charts: Charts,\n) => {\n  let itemToPass: TreeItem = treeItem;\n  if (isShowTypeInTree(node, charts) && node.type !== DASHBOARD_ROOT_TYPE) {\n    const currentTreeItem = {\n      key: node.id,\n      title: node.meta.sliceName || node.meta.text || node.id.toString(),\n      children: [],\n    };\n    treeItem.children.push(currentTreeItem);\n    itemToPass = currentTreeItem;\n  }\n  node.children.forEach(child =>\n    buildTree(layout[child], itemToPass, layout, charts),\n  );\n};\n\nexport const findFilterScope = (\n  checkedKeys: string[],\n  layout: Layout,\n): Scope => {\n  if (!checkedKeys.length) {\n    return {\n      rootPath: [],\n      excluded: [],\n    };\n  }\n  const checkedItemParents = checkedKeys.map(key =>\n    (layout[key].parents || []).filter(parent =>\n      isShowTypeInTree(layout[parent]),\n    ),\n  );\n  checkedItemParents.sort((p1, p2) => p1.length - p2.length);\n  const rootPath = checkedItemParents.map(\n    parents => parents[checkedItemParents[0].length - 1],\n  );\n\n  const excluded: number[] = [];\n  const isExcluded = (parent: string, item: string) =>\n    rootPath.includes(parent) && !checkedKeys.includes(item);\n\n  Object.entries(layout).forEach(([key, value]) => {\n    if (\n      value.type === CHART_TYPE &&\n      value.parents?.find(parent => isExcluded(parent, key))\n    ) {\n      excluded.push(value.meta.chartId);\n    }\n  });\n\n  return {\n    rootPath: [...new Set(rootPath)],\n    excluded,\n  };\n};\n\nexport function mergeExtraFormData(\n  originalExtra: ExtraFormData,\n  newExtra: ExtraFormData,\n): ExtraFormData {\n  const {\n    override_form_data: originalOverride = {},\n    append_form_data: originalAppend = {},\n  } = originalExtra;\n  const {\n    override_form_data: newOverride = {},\n    append_form_data: newAppend = {},\n  } = newExtra;\n\n  const appendKeys = new Set([\n    ...Object.keys(originalAppend),\n    ...Object.keys(newAppend),\n  ]);\n  const appendFormData: Partial<QueryObject> = {};\n  appendKeys.forEach(key => {\n    appendFormData[key] = [\n      // @ts-ignore\n      ...(originalAppend[key] || []),\n      // @ts-ignore\n      ...(newAppend[key] || []),\n    ];\n  });\n\n  return {\n    override_form_data: {\n      ...originalOverride,\n      ...newOverride,\n    },\n    append_form_data: appendFormData,\n  };\n}\n\nexport function getExtraFormData(\n  nativeFilters: NativeFiltersState,\n): ExtraFormData {\n  let extraFormData: ExtraFormData = {};\n  Object.keys(nativeFilters.filters).forEach(key => {\n    const filterState = nativeFilters.filtersState[key] || {};\n    const { extraFormData: newExtra = {} } = filterState;\n    extraFormData = mergeExtraFormData(extraFormData, newExtra);\n  });\n  return extraFormData;\n}\n\nexport function mapParentFiltersToChildren(\n  filters: Filter[],\n): { [id: string]: Filter[] } {\n  const cascadeChildren = {};\n  filters.forEach(filter => {\n    const [parentId] = filter.cascadeParentIds || [];\n    if (parentId) {\n      if (!cascadeChildren[parentId]) {\n        cascadeChildren[parentId] = [];\n      }\n      cascadeChildren[parentId].push(filter);\n    }\n  });\n  return cascadeChildren;\n}\n\nexport function buildCascadeFiltersTree(filters: Filter[]): CascadeFilter[] {\n  const cascadeChildren = mapParentFiltersToChildren(filters);\n\n  const getCascadeFilter = (filter: Filter): CascadeFilter => {\n    const children = cascadeChildren[filter.id] || [];\n    return {\n      ...filter,\n      cascadeChildren: children.map(getCascadeFilter),\n    };\n  };\n\n  return filters\n    .filter(filter => !filter.cascadeParentIds?.length)\n    .map(getCascadeFilter);\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}