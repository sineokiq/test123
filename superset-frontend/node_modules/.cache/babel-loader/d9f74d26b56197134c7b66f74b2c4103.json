{"ast":null,"code":"import _Object$keys from \"@babel/runtime-corejs3/core-js-stable/object/keys\";import _sliceInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/slice\";import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _filterInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/filter\";import _bindInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/bind\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport Button from 'src/components/Button';\nimport Select from 'src/components/Select';\nimport { styled, t, SupersetClient } from '@superset-ui/core';\n\nimport Loading from '../../components/Loading';\nimport QueryTable from './QueryTable';\nimport {\nnow,\nepochTimeXHoursAgo,\nepochTimeXDaysAgo,\nepochTimeXYearsAgo } from\n'../../modules/dates';\nimport { STATUS_OPTIONS, TIME_OPTIONS } from '../constants';\nimport AsyncSelect from '../../components/AsyncSelect';import { jsx as ___EmotionJSX } from \"@emotion/core\";\n\nconst propTypes = {\n  actions: PropTypes.object.isRequired,\n  height: PropTypes.oneOfType([PropTypes.string, PropTypes.number]).isRequired,\n  displayLimit: PropTypes.number.isRequired };\n\n\nconst TableWrapper = styled.div`\n  display: flex;\n  flex-direction: column;\n  flex: 1;\n  height: 100%;\n`;\n\nconst TableStyles = styled.div`\n  table {\n    background-color: ${({ theme }) => theme.colors.grayscale.light4};\n  }\n\n  .table > thead > tr > th {\n    border-bottom: ${({ theme }) => theme.gridUnit / 2}px solid\n      ${({ theme }) => theme.colors.grayscale.light2};\n    background: ${({ theme }) => theme.colors.grayscale.light4};\n  }\n`;\n\nconst StyledTableStylesContainer = styled.div`\n  overflow: auto;\n`;\n\nclass QuerySearch extends React.PureComponent {\n  constructor(props) {var _context, _context2, _context3, _context4, _context5, _context6, _context7, _context8, _context9, _context10, _context11, _context12;\n    super(props);\n    this.state = {\n      databaseId: null,\n      userId: null,\n      searchText: null,\n      from: '28 days ago',\n      to: 'now',\n      status: 'success',\n      queriesArray: [],\n      queriesLoading: true };\n\n    this.userMutator = _bindInstanceProperty(_context = this.userMutator).call(_context, this);\n    this.changeUser = _bindInstanceProperty(_context2 = this.changeUser).call(_context2, this);\n    this.dbMutator = _bindInstanceProperty(_context3 = this.dbMutator).call(_context3, this);\n    this.onChange = _bindInstanceProperty(_context4 = this.onChange).call(_context4, this);\n    this.changeSearch = _bindInstanceProperty(_context5 = this.changeSearch).call(_context5, this);\n    this.onKeyDown = _bindInstanceProperty(_context6 = this.onKeyDown).call(_context6, this);\n    this.changeFrom = _bindInstanceProperty(_context7 = this.changeFrom).call(_context7, this);\n    this.changeTo = _bindInstanceProperty(_context8 = this.changeTo).call(_context8, this);\n    this.changeStatus = _bindInstanceProperty(_context9 = this.changeStatus).call(_context9, this);\n    this.refreshQueries = _bindInstanceProperty(_context10 = this.refreshQueries).call(_context10, this);\n    this.onUserClicked = _bindInstanceProperty(_context11 = this.onUserClicked).call(_context11, this);\n    this.onDbClicked = _bindInstanceProperty(_context12 = this.onDbClicked).call(_context12, this);\n  }\n\n  componentDidMount() {\n    this.refreshQueries();\n  }\n\n  onUserClicked(userId) {\n    this.setState({ userId }, () => {\n      this.refreshQueries();\n    });\n  }\n\n  onDbClicked(dbId) {\n    this.setState({ databaseId: dbId }, () => {\n      this.refreshQueries();\n    });\n  }\n\n  onChange(db) {\n    const val = db ? db.value : null;\n    this.setState({ databaseId: val });\n  }\n\n  onKeyDown(event) {\n    if (event.keyCode === 13) {\n      this.refreshQueries();\n    }\n  }\n\n  getTimeFromSelection(selection) {\n    switch (selection) {\n      case 'now':\n        return now();\n      case '1 hour ago':\n        return epochTimeXHoursAgo(1);\n      case '1 day ago':\n        return epochTimeXDaysAgo(1);\n      case '7 days ago':\n        return epochTimeXDaysAgo(7);\n      case '28 days ago':\n        return epochTimeXDaysAgo(28);\n      case '90 days ago':\n        return epochTimeXDaysAgo(90);\n      case '1 year ago':\n        return epochTimeXYearsAgo(1);\n      default:\n        return null;}\n\n  }\n\n  changeFrom(user) {\n    const val = user ? user.value : null;\n    this.setState({ from: val });\n  }\n\n  changeTo(status) {\n    const val = status ? status.value : null;\n    this.setState({ to: val });\n  }\n\n  changeUser(user) {\n    const val = user ? user.value : null;\n    this.setState({ userId: val });\n  }\n\n  insertParams(baseUrl, params) {\n    const validParams = _filterInstanceProperty(params).call(params, function (p) {\n      return p !== '';\n    });\n    return `${baseUrl}?${validParams.join('&')}`;\n  }\n\n  changeStatus(status) {\n    const val = status ? status.value : null;\n    this.setState({ status: val });\n  }\n\n  changeSearch(event) {\n    this.setState({ searchText: event.target.value });\n  }\n\n  userLabel(user) {\n    if (user.first_name && user.last_name) {\n      return `${user.first_name} ${user.last_name}`;\n    }\n    return user.username;\n  }\n\n  userMutator(data) {var _context13;\n    return _mapInstanceProperty(_context13 = data.result).call(_context13, ({ value, text }) => ({\n      label: text,\n      value }));\n\n  }\n\n  dbMutator(data) {var _context14;\n    const options = _mapInstanceProperty(_context14 = data.result).call(_context14, db => ({\n      value: db.id,\n      label: db.database_name }));\n\n    this.props.actions.setDatabases(data.result);\n    if (data.result.length === 0) {\n      this.props.actions.addDangerToast(\n      t(\"It seems you don't have access to any database\"));\n\n    }\n    return options;\n  }\n\n  refreshQueries() {\n    this.setState({ queriesLoading: true });\n    const params = [\n    this.state.userId ? `user_id=${this.state.userId}` : '',\n    this.state.databaseId ? `database_id=${this.state.databaseId}` : '',\n    this.state.searchText ? `search_text=${this.state.searchText}` : '',\n    this.state.status ? `status=${this.state.status}` : '',\n    this.state.from ?\n    `from=${this.getTimeFromSelection(this.state.from)}` :\n    '',\n    this.state.to ? `to=${this.getTimeFromSelection(this.state.to)}` : ''];\n\n\n    SupersetClient.get({\n      endpoint: this.insertParams('/superset/search_queries', params) }).\n\n    then(({ json }) => {\n      this.setState({ queriesArray: json, queriesLoading: false });\n    }).\n    catch(() => {\n      this.props.actions.addDangerToast(\n      t('An error occurred when refreshing queries'));\n\n    });\n  }\n\n  render() {var _context15, _context16;\n    return (\n      ___EmotionJSX(TableWrapper, null,\n      ___EmotionJSX(\"div\", { id: \"search-header\", className: \"row space-1\" },\n      ___EmotionJSX(\"div\", { className: \"col-sm-2\" },\n      ___EmotionJSX(AsyncSelect, {\n        dataEndpoint: \"api/v1/query/related/user\",\n        mutator: this.userMutator,\n        value: this.state.userId,\n        onChange: this.changeUser,\n        placeholder: t('Filter by user') })),\n\n\n      ___EmotionJSX(\"div\", { className: \"col-sm-2\" },\n      ___EmotionJSX(AsyncSelect, {\n        onChange: this.onChange,\n        dataEndpoint: \"/api/v1/database/?q=(filters:!((col:expose_in_sqllab,opr:eq,value:!t)))\",\n        value: this.state.databaseId,\n        mutator: this.dbMutator,\n        placeholder: t('Filter by database') })),\n\n\n      ___EmotionJSX(\"div\", { className: \"col-sm-4\" },\n      ___EmotionJSX(\"input\", {\n        type: \"text\",\n        onChange: this.changeSearch,\n        onKeyDown: this.onKeyDown,\n        className: \"form-control input-sm\",\n        placeholder: t('Query search string') })),\n\n\n      ___EmotionJSX(\"div\", { className: \"col-sm-4 search-date-filter-container\" },\n      ___EmotionJSX(Select, {\n        name: \"select-from\",\n        placeholder: t('[From]-'),\n        options: _mapInstanceProperty(_context15 = _sliceInstanceProperty(TIME_OPTIONS).call(TIME_OPTIONS, 1, TIME_OPTIONS.length)).call(_context15, xt => ({\n          value: xt,\n          label: xt })),\n\n        value: this.state.from,\n        autosize: false,\n        onChange: this.changeFrom }),\n\n\n      ___EmotionJSX(Select, {\n        name: \"select-to\",\n        placeholder: t('[To]-'),\n        options: _mapInstanceProperty(TIME_OPTIONS).call(TIME_OPTIONS, xt => ({ value: xt, label: xt })),\n        value: this.state.to,\n        autosize: false,\n        onChange: this.changeTo }),\n\n\n      ___EmotionJSX(Select, {\n        name: \"select-status\",\n        placeholder: t('Filter by status'),\n        options: _mapInstanceProperty(_context16 = _Object$keys(STATUS_OPTIONS)).call(_context16, s => ({\n          value: s,\n          label: s })),\n\n        value: this.state.status,\n        isLoading: false,\n        autosize: false,\n        onChange: this.changeStatus }),\n\n\n      ___EmotionJSX(Button, {\n        buttonSize: \"small\",\n        buttonStyle: \"success\",\n        onClick: this.refreshQueries },\n\n      t('Search')))),\n\n\n\n      ___EmotionJSX(StyledTableStylesContainer, null,\n      this.state.queriesLoading ?\n      ___EmotionJSX(Loading, null) :\n\n      ___EmotionJSX(TableStyles, null,\n      ___EmotionJSX(QueryTable, {\n        columns: [\n        'state',\n        'db',\n        'user',\n        'time',\n        'progress',\n        'rows',\n        'sql',\n        'querylink'],\n\n        onUserClicked: this.onUserClicked,\n        onDbClicked: this.onDbClicked,\n        queries: this.state.queriesArray,\n        actions: this.props.actions,\n        displayLimit: this.props.displayLimit })))));\n\n\n\n\n\n\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}QuerySearch.propTypes = propTypes;const _default =\nQuerySearch;export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(propTypes, \"propTypes\", \"/app/superset-frontend/src/SqlLab/components/QuerySearch.jsx\");reactHotLoader.register(TableWrapper, \"TableWrapper\", \"/app/superset-frontend/src/SqlLab/components/QuerySearch.jsx\");reactHotLoader.register(TableStyles, \"TableStyles\", \"/app/superset-frontend/src/SqlLab/components/QuerySearch.jsx\");reactHotLoader.register(StyledTableStylesContainer, \"StyledTableStylesContainer\", \"/app/superset-frontend/src/SqlLab/components/QuerySearch.jsx\");reactHotLoader.register(QuerySearch, \"QuerySearch\", \"/app/superset-frontend/src/SqlLab/components/QuerySearch.jsx\");reactHotLoader.register(_default, \"default\", \"/app/superset-frontend/src/SqlLab/components/QuerySearch.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/app/superset-frontend/src/SqlLab/components/QuerySearch.jsx"],"names":["React","PropTypes","Button","Select","styled","t","SupersetClient","Loading","QueryTable","now","epochTimeXHoursAgo","epochTimeXDaysAgo","epochTimeXYearsAgo","STATUS_OPTIONS","TIME_OPTIONS","AsyncSelect","propTypes","actions","object","isRequired","height","oneOfType","string","number","displayLimit","TableWrapper","div","TableStyles","theme","colors","grayscale","light4","gridUnit","light2","StyledTableStylesContainer","QuerySearch","PureComponent","constructor","props","state","databaseId","userId","searchText","from","to","status","queriesArray","queriesLoading","userMutator","changeUser","dbMutator","onChange","changeSearch","onKeyDown","changeFrom","changeTo","changeStatus","refreshQueries","onUserClicked","onDbClicked","componentDidMount","setState","dbId","db","val","value","event","keyCode","getTimeFromSelection","selection","user","insertParams","baseUrl","params","validParams","p","join","target","userLabel","first_name","last_name","username","data","result","text","label","options","id","database_name","setDatabases","length","addDangerToast","get","endpoint","then","json","catch","render","xt","s"],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport Button from 'src/components/Button';\nimport Select from 'src/components/Select';\nimport { styled, t, SupersetClient } from '@superset-ui/core';\n\nimport Loading from '../../components/Loading';\nimport QueryTable from './QueryTable';\nimport {\n  now,\n  epochTimeXHoursAgo,\n  epochTimeXDaysAgo,\n  epochTimeXYearsAgo,\n} from '../../modules/dates';\nimport { STATUS_OPTIONS, TIME_OPTIONS } from '../constants';\nimport AsyncSelect from '../../components/AsyncSelect';\n\nconst propTypes = {\n  actions: PropTypes.object.isRequired,\n  height: PropTypes.oneOfType([PropTypes.string, PropTypes.number]).isRequired,\n  displayLimit: PropTypes.number.isRequired,\n};\n\nconst TableWrapper = styled.div`\n  display: flex;\n  flex-direction: column;\n  flex: 1;\n  height: 100%;\n`;\n\nconst TableStyles = styled.div`\n  table {\n    background-color: ${({ theme }) => theme.colors.grayscale.light4};\n  }\n\n  .table > thead > tr > th {\n    border-bottom: ${({ theme }) => theme.gridUnit / 2}px solid\n      ${({ theme }) => theme.colors.grayscale.light2};\n    background: ${({ theme }) => theme.colors.grayscale.light4};\n  }\n`;\n\nconst StyledTableStylesContainer = styled.div`\n  overflow: auto;\n`;\n\nclass QuerySearch extends React.PureComponent {\n  constructor(props) {\n    super(props);\n    this.state = {\n      databaseId: null,\n      userId: null,\n      searchText: null,\n      from: '28 days ago',\n      to: 'now',\n      status: 'success',\n      queriesArray: [],\n      queriesLoading: true,\n    };\n    this.userMutator = this.userMutator.bind(this);\n    this.changeUser = this.changeUser.bind(this);\n    this.dbMutator = this.dbMutator.bind(this);\n    this.onChange = this.onChange.bind(this);\n    this.changeSearch = this.changeSearch.bind(this);\n    this.onKeyDown = this.onKeyDown.bind(this);\n    this.changeFrom = this.changeFrom.bind(this);\n    this.changeTo = this.changeTo.bind(this);\n    this.changeStatus = this.changeStatus.bind(this);\n    this.refreshQueries = this.refreshQueries.bind(this);\n    this.onUserClicked = this.onUserClicked.bind(this);\n    this.onDbClicked = this.onDbClicked.bind(this);\n  }\n\n  componentDidMount() {\n    this.refreshQueries();\n  }\n\n  onUserClicked(userId) {\n    this.setState({ userId }, () => {\n      this.refreshQueries();\n    });\n  }\n\n  onDbClicked(dbId) {\n    this.setState({ databaseId: dbId }, () => {\n      this.refreshQueries();\n    });\n  }\n\n  onChange(db) {\n    const val = db ? db.value : null;\n    this.setState({ databaseId: val });\n  }\n\n  onKeyDown(event) {\n    if (event.keyCode === 13) {\n      this.refreshQueries();\n    }\n  }\n\n  getTimeFromSelection(selection) {\n    switch (selection) {\n      case 'now':\n        return now();\n      case '1 hour ago':\n        return epochTimeXHoursAgo(1);\n      case '1 day ago':\n        return epochTimeXDaysAgo(1);\n      case '7 days ago':\n        return epochTimeXDaysAgo(7);\n      case '28 days ago':\n        return epochTimeXDaysAgo(28);\n      case '90 days ago':\n        return epochTimeXDaysAgo(90);\n      case '1 year ago':\n        return epochTimeXYearsAgo(1);\n      default:\n        return null;\n    }\n  }\n\n  changeFrom(user) {\n    const val = user ? user.value : null;\n    this.setState({ from: val });\n  }\n\n  changeTo(status) {\n    const val = status ? status.value : null;\n    this.setState({ to: val });\n  }\n\n  changeUser(user) {\n    const val = user ? user.value : null;\n    this.setState({ userId: val });\n  }\n\n  insertParams(baseUrl, params) {\n    const validParams = params.filter(function (p) {\n      return p !== '';\n    });\n    return `${baseUrl}?${validParams.join('&')}`;\n  }\n\n  changeStatus(status) {\n    const val = status ? status.value : null;\n    this.setState({ status: val });\n  }\n\n  changeSearch(event) {\n    this.setState({ searchText: event.target.value });\n  }\n\n  userLabel(user) {\n    if (user.first_name && user.last_name) {\n      return `${user.first_name} ${user.last_name}`;\n    }\n    return user.username;\n  }\n\n  userMutator(data) {\n    return data.result.map(({ value, text }) => ({\n      label: text,\n      value,\n    }));\n  }\n\n  dbMutator(data) {\n    const options = data.result.map(db => ({\n      value: db.id,\n      label: db.database_name,\n    }));\n    this.props.actions.setDatabases(data.result);\n    if (data.result.length === 0) {\n      this.props.actions.addDangerToast(\n        t(\"It seems you don't have access to any database\"),\n      );\n    }\n    return options;\n  }\n\n  refreshQueries() {\n    this.setState({ queriesLoading: true });\n    const params = [\n      this.state.userId ? `user_id=${this.state.userId}` : '',\n      this.state.databaseId ? `database_id=${this.state.databaseId}` : '',\n      this.state.searchText ? `search_text=${this.state.searchText}` : '',\n      this.state.status ? `status=${this.state.status}` : '',\n      this.state.from\n        ? `from=${this.getTimeFromSelection(this.state.from)}`\n        : '',\n      this.state.to ? `to=${this.getTimeFromSelection(this.state.to)}` : '',\n    ];\n\n    SupersetClient.get({\n      endpoint: this.insertParams('/superset/search_queries', params),\n    })\n      .then(({ json }) => {\n        this.setState({ queriesArray: json, queriesLoading: false });\n      })\n      .catch(() => {\n        this.props.actions.addDangerToast(\n          t('An error occurred when refreshing queries'),\n        );\n      });\n  }\n\n  render() {\n    return (\n      <TableWrapper>\n        <div id=\"search-header\" className=\"row space-1\">\n          <div className=\"col-sm-2\">\n            <AsyncSelect\n              dataEndpoint=\"api/v1/query/related/user\"\n              mutator={this.userMutator}\n              value={this.state.userId}\n              onChange={this.changeUser}\n              placeholder={t('Filter by user')}\n            />\n          </div>\n          <div className=\"col-sm-2\">\n            <AsyncSelect\n              onChange={this.onChange}\n              dataEndpoint=\"/api/v1/database/?q=(filters:!((col:expose_in_sqllab,opr:eq,value:!t)))\"\n              value={this.state.databaseId}\n              mutator={this.dbMutator}\n              placeholder={t('Filter by database')}\n            />\n          </div>\n          <div className=\"col-sm-4\">\n            <input\n              type=\"text\"\n              onChange={this.changeSearch}\n              onKeyDown={this.onKeyDown}\n              className=\"form-control input-sm\"\n              placeholder={t('Query search string')}\n            />\n          </div>\n          <div className=\"col-sm-4 search-date-filter-container\">\n            <Select\n              name=\"select-from\"\n              placeholder={t('[From]-')}\n              options={TIME_OPTIONS.slice(1, TIME_OPTIONS.length).map(xt => ({\n                value: xt,\n                label: xt,\n              }))}\n              value={this.state.from}\n              autosize={false}\n              onChange={this.changeFrom}\n            />\n\n            <Select\n              name=\"select-to\"\n              placeholder={t('[To]-')}\n              options={TIME_OPTIONS.map(xt => ({ value: xt, label: xt }))}\n              value={this.state.to}\n              autosize={false}\n              onChange={this.changeTo}\n            />\n\n            <Select\n              name=\"select-status\"\n              placeholder={t('Filter by status')}\n              options={Object.keys(STATUS_OPTIONS).map(s => ({\n                value: s,\n                label: s,\n              }))}\n              value={this.state.status}\n              isLoading={false}\n              autosize={false}\n              onChange={this.changeStatus}\n            />\n\n            <Button\n              buttonSize=\"small\"\n              buttonStyle=\"success\"\n              onClick={this.refreshQueries}\n            >\n              {t('Search')}\n            </Button>\n          </div>\n        </div>\n        <StyledTableStylesContainer>\n          {this.state.queriesLoading ? (\n            <Loading />\n          ) : (\n            <TableStyles>\n              <QueryTable\n                columns={[\n                  'state',\n                  'db',\n                  'user',\n                  'time',\n                  'progress',\n                  'rows',\n                  'sql',\n                  'querylink',\n                ]}\n                onUserClicked={this.onUserClicked}\n                onDbClicked={this.onDbClicked}\n                queries={this.state.queriesArray}\n                actions={this.props.actions}\n                displayLimit={this.props.displayLimit}\n              />\n            </TableStyles>\n          )}\n        </StyledTableStylesContainer>\n      </TableWrapper>\n    );\n  }\n}\nQuerySearch.propTypes = propTypes;\nexport default QuerySearch;\n"]},"metadata":{},"sourceType":"module"}